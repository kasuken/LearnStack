@using MudBlazor
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

@* Theme Provider with Custom Theme *@
<MudThemeProvider Theme="@_theme" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Class="app-header" Style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid #e2e8f0;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/resources"))">
            <div style="background: linear-gradient(135deg, #4f46e5, #818cf8); border-radius: 10px; padding: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);">
                <MudIcon Icon="@Icons.Material.Filled.AutoStories" Style="color: white;" Size="Size.Medium" />
            </div>
            <MudText Typo="Typo.h6" Style="font-weight: 700; color: #0f172a; letter-spacing: -0.5px;">
                LearnStack
            </MudText>
        </MudStack>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Style="background: #4f46e5; font-weight: 600; color: white;" Size="Size.Medium">
                            @GetUserInitials(context.User.Identity?.Name)
                        </MudAvatar>
                        <MudStack Spacing="0" Class="d-none d-sm-flex">
                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #0f172a;">@context.User.Identity?.Name?.Split('@')[0]</MudText>
                            <MudText Typo="Typo.caption" Style="color: #475569;">@GetUserEmail(context.User)</MudText>
                        </MudStack>
                    </MudStack>
                    <MudMenu Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                            Dense="true" PopoverClass="rounded-xl shadow-lg border border-slate-100">
                        <MudMenuItem Href="Account/Manage" Style="padding: 12px 16px; border-radius: 8px; margin: 4px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Style="color: #475569;" />
                                <MudText Style="color: #0f172a; font-weight: 500;">Manage Account</MudText>
                            </MudStack>
                        </MudMenuItem>
                        <MudMenuItem Href="Account/Manage/ChangePassword" Style="padding: 12px 16px; border-radius: 8px; margin: 4px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Style="color: #475569;" />
                                <MudText Style="color: #0f172a; font-weight: 500;">Change Password</MudText>
                            </MudStack>
                        </MudMenuItem>
                        <MudDivider Class="my-1" />
                        <MudMenuItem Style="padding: 12px 16px; border-radius: 8px; margin: 4px;">
                            <form action="Account/Logout" method="post">
                                <AntiforgeryToken />
                                <input type="hidden" name="returnUrl" value="/" />
                                <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer; width: 100%; text-align: left;">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small" Style="color: #ef4444;" />
                                        <MudText Style="color: #ef4444; font-weight: 600;">Sign Out</MudText>
                                    </MudStack>
                                </button>
                            </form>
                        </MudMenuItem>
                    </MudMenu>
                </MudStack>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="Account/Login" Variant="Variant.Filled" Color="Color.Primary"
                          Style="font-weight: 600; padding: 8px 24px; border-radius: 8px; text-transform: none; letter-spacing: 0;">
                    Sign In
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    <MudMainContent Style="background: #f8fafc; min-height: 100vh; padding-top: 64px;">
        @Body
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#4f46e5",
            PrimaryDarken = "#4338ca",
            PrimaryLighten = "#818cf8",
            Secondary = "#0f172a",
            SecondaryDarken = "#020617",
            SecondaryLighten = "#334155",
            Success = "#10b981",
            SuccessDarken = "#059669",
            SuccessLighten = "#34d399",
            Warning = "#f59e0b",
            WarningDarken = "#d97706",
            WarningLighten = "#fbbf24",
            Error = "#ef4444",
            ErrorDarken = "#dc2626",
            ErrorLighten = "#f87171",
            Info = "#3b82f6",
            InfoDarken = "#2563eb",
            InfoLighten = "#60a5fa",
            Background = "#f8fafc",
            Surface = "#ffffff",
            TextPrimary = "#0f172a",
            TextSecondary = "#475569",
            DrawerBackground = "#ffffff"
        },
        Typography = new Typography()
        {
            Default = new DefaultTypography()
            {
                FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" },
                FontSize = "1rem",
                FontWeight = "400",
                LineHeight = "1.5",
                LetterSpacing = "normal"
            },
            H1 = new H1Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "3.5rem", FontWeight = "700", LineHeight = "1.2", LetterSpacing = "-0.02em" },
            H2 = new H2Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "2.5rem", FontWeight = "700", LineHeight = "1.2", LetterSpacing = "-0.01em" },
            H3 = new H3Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "2rem", FontWeight = "600", LineHeight = "1.2", LetterSpacing = "-0.01em" },
            H4 = new H4Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "1.5rem", FontWeight = "600", LineHeight = "1.3", LetterSpacing = "normal" },
            H5 = new H5Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "1.25rem", FontWeight = "600", LineHeight = "1.4", LetterSpacing = "normal" },
            H6 = new H6Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "1.125rem", FontWeight = "600", LineHeight = "1.4", LetterSpacing = "normal" },
            Button = new ButtonTypography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "0.875rem", FontWeight = "600", LineHeight = "1.75", LetterSpacing = "0.02em", TextTransform = "none" },
            Body1 = new Body1Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "1rem", FontWeight = "400", LineHeight = "1.5", LetterSpacing = "normal" },
            Body2 = new Body2Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "0.875rem", FontWeight = "400", LineHeight = "1.43", LetterSpacing = "normal" },
            Subtitle1 = new Subtitle1Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "1rem", FontWeight = "500", LineHeight = "1.75", LetterSpacing = "normal" },
            Subtitle2 = new Subtitle2Typography() { FontFamily = new[] { "Inter", "system-ui", "-apple-system", "sans-serif" }, FontSize = "0.875rem", FontWeight = "500", LineHeight = "1.57", LetterSpacing = "normal" }
        },
        LayoutProperties = new LayoutProperties()
        {
            DefaultBorderRadius = "16px"
        }
    };

    private string GetUserInitials(string? name)
    {
        if (string.IsNullOrEmpty(name))
            return "U";
        
        var parts = name.Split('@')[0].Split('.');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string GetUserEmail(System.Security.Claims.ClaimsPrincipal user)
    {
        return user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value 
               ?? user.Identity?.Name 
               ?? "User";
    }
}
