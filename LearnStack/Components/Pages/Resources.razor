@page "/resources"
@using LearnStack.Services
@using System.Text
@using System.Text.Json
@attribute [Authorize]
@inject ILearningResourceService ResourceService
@inject IContentIdeaService ContentIdeaService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Learning Resources - LearnStack</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    @* Page Header *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4 page-header animate-fade-in-up">
        <MudStack Spacing="1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <div style="background: linear-gradient(135deg, #4f46e5, #818cf8); border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);">
                    <MudIcon Icon="@Icons.Material.Filled.AutoStories" Style="color: white;" Size="Size.Medium" />
                </div>
                <MudText Typo="Typo.h5" Class="page-title" Style="font-weight: 700; letter-spacing: -0.5px;">Learning Resources</MudText>
            </MudStack>
            <MudText Typo="Typo.body2" Class="page-subtitle">Track and organize your learning materials</MudText>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" 
                      StartIcon="@Icons.Material.Filled.Share" 
                      OnClick="@(() => NavigationManager.NavigateTo("/shared-groups"))" 
                      Style="border-radius: 10px; font-weight: 600;">
                Shared Collections
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                      StartIcon="@Icons.Material.Filled.Lightbulb" 
                      OnClick="@(() => NavigationManager.NavigateTo("/content-ideas"))" 
                      Style="border-radius: 10px; font-weight: 600;">
                Content Ideas
            </MudButton>
            <MudMenu Label="Export" Variant="Variant.Outlined" EndIcon="@Icons.Material.Filled.KeyboardArrowDown" IconColor="Color.Primary" Style="border-radius: 10px; font-weight: 600;">
                <MudMenuItem Icon="@Icons.Material.Filled.Download" OnClick="ExportAsJson">Export as JSON</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Download" OnClick="ExportAsCsv">Export as CSV</MudMenuItem>
            </MudMenu>
        </MudStack>
    </MudStack>

    @* Statistics Cards *@
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="6" sm="3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e0e7ff;">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Style="color: #4f46e5;" />
                </div>
                <div class="stat-content">
                    <span class="stat-value">@toLearnCount</span>
                    <span class="stat-label">To Learn</span>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" sm="3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7;">
                    <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Style="color: #f59e0b;" />
                </div>
                <div class="stat-content">
                    <span class="stat-value">@inProgressCount</span>
                    <span class="stat-label">In Progress</span>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" sm="3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #dcfce7;">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #10b981;" />
                </div>
                <div class="stat-content">
                    <span class="stat-value">@completedCount</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
        </MudItem>
        <MudItem xs="6" sm="3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #dbeafe;">
                    <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Style="color: #3b82f6;" />
                </div>
                <div class="stat-content">
                    <span class="stat-value">@contentIdeasCount</span>
                    <span class="stat-label">Content Ideas</span>
                </div>
            </div>
        </MudItem>
    </MudGrid>

    @* Tabs *@
    <MudTabs ActivePanelIndex="@activeTabIndex" ActivePanelIndexChanged="OnTabChangedAsync" Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4" Style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
        <MudTabPanel Icon="@Icons.Material.Filled.MenuBook" Text="To Learn" BadgeColor="Color.Primary" />
        <MudTabPanel Icon="@Icons.Material.Filled.PlayCircle" Text="Learning" />
        <MudTabPanel Icon="@Icons.Material.Filled.CheckCircle" Text="Completed" />
        <MudTabPanel Icon="@Icons.Material.Filled.GridView" Text="All Resources" />
    </MudTabs>

    @* Search and Filters Row *@
    <MudPaper Class="filter-section" Elevation="0" Style="padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
        <MudGrid Spacing="3" Justify="Justify.SpaceBetween">
            <MudItem xs="12" md="5">
                <MudTextField @bind-Value="searchTerm"
                             Placeholder="Search resources by title, description, notes, or tags..."
                             Variant="Variant.Outlined"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             Immediate="true"
                             DebounceInterval="300"
                             OnDebounceIntervalElapsed="ApplyFiltersWithReset"
                             Class="search-input"
                             Style="background-color: white; border-radius: 12px;" />
            </MudItem>
            <MudItem xs="12" md="7">
                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center">
                    <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small" Style="border-radius: 10px; overflow: hidden;">
                        <MudIconButton Icon="@Icons.Material.Filled.ViewList" 
                                      Color="@(viewMode == ViewMode.List ? Color.Primary : Color.Default)"
                                      OnClick="@(() => { viewMode = ViewMode.List; StateHasChanged(); })"
                                      Title="List View" />
                        <MudIconButton Icon="@Icons.Material.Filled.TableChart" 
                                      Color="@(viewMode == ViewMode.DataGrid ? Color.Primary : Color.Default)"
                                      OnClick="@(() => { viewMode = ViewMode.DataGrid; StateHasChanged(); })"
                                      Title="Table View" />
                    </MudButtonGroup>
                    <MudButton Variant="Variant.Outlined"
                              EndIcon="@(showFilters ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                              OnClick="@(() => showFilters = !showFilters)"
                              Style="border-radius: 10px; font-weight: 600;">
                        Filters
                    </MudButton>
                    <MudSelect @bind-Value="sortOrder"
                              @bind-Value:after="OnFilterChanged"
                              Variant="Variant.Outlined"
                              T="string"
                              Style="width: 160px; background-color: white; border-radius: 10px;">
                        <MudSelectItem Value="@("custom")">Custom Order</MudSelectItem>
                        <MudSelectItem Value="@("newest")">Newest First</MudSelectItem>
                        <MudSelectItem Value="@("oldest")">Oldest First</MudSelectItem>
                        <MudSelectItem Value="@("priority")">By Priority</MudSelectItem>
                        <MudSelectItem Value="@("title")">By Title</MudSelectItem>
                    </MudSelect>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="OpenAddDialog"
                              Style="border-radius: 10px; font-weight: 600; padding: 8px 16px; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);">
                        Add Resource
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>

        @* Expandable Filters *@
        <MudCollapse Expanded="showFilters">
            <MudGrid Class="mt-4" Spacing="3">
                <MudItem xs="12" sm="4">
                    <MudSelect @bind-Value="filterContentType"
                              @bind-Value:after="OnFilterChanged"
                              Label="Content Type"
                              Variant="Variant.Outlined"
                              T="ContentType?"
                              Clearable="true"
                              Style="background-color: white;">
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.BlogPost)">Blog Post</MudSelectItem>
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.Podcast)">Podcast</MudSelectItem>
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.Video)">Video</MudSelectItem>
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.Article)">Article</MudSelectItem>
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.Course)">Course</MudSelectItem>
                        <MudSelectItem T="ContentType?" Value="@((ContentType?)ContentType.Documentation)">Documentation</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect @bind-Value="filterStatus"
                              @bind-Value:after="OnFilterChanged"
                              Label="Status"
                              Variant="Variant.Outlined"
                              T="ContentStatus?"
                              Clearable="true"
                              Style="background-color: white;">
                        <MudSelectItem T="ContentStatus?" Value="@((ContentStatus?)ContentStatus.ToLearn)">To Learn</MudSelectItem>
                        <MudSelectItem T="ContentStatus?" Value="@((ContentStatus?)ContentStatus.InProgress)">In Progress</MudSelectItem>
                        <MudSelectItem T="ContentStatus?" Value="@((ContentStatus?)ContentStatus.Completed)">Completed</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect @bind-Value="filterPriority"
                              @bind-Value:after="OnFilterChanged"
                              Label="Priority"
                              Variant="Variant.Outlined"
                              T="Priority?"
                              Clearable="true"
                              Style="background-color: white;">
                        <MudSelectItem T="Priority?" Value="@((Priority?)Priority.High)">High</MudSelectItem>
                        <MudSelectItem T="Priority?" Value="@((Priority?)Priority.Medium)">Medium</MudSelectItem>
                        <MudSelectItem T="Priority?" Value="@((Priority?)Priority.Low)">Low</MudSelectItem>
                    </MudSelect>
                </MudItem>
                @if (activeTabIndex == 3)
                {
                    <MudItem xs="12">
                        <MudSwitch @bind-Value="showArchived" @bind-Value:after="OnFilterChanged" Color="Color.Primary" Label="Show Archived" />
                    </MudItem>
                }
            </MudGrid>
        </MudCollapse>
    </MudPaper>

    @* Resource List *@
    @if (isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="padding: 4rem;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body2" Style="color: #64748b; margin-top: 1rem;">Loading your resources...</MudText>
        </MudStack>
    }
    else if (!filteredResources.Any())
    {
        <div class="empty-state animate-fade-in-up">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Filled.AutoStories" Size="Size.Large" Style="color: #94a3b8;" />
            </div>
            @if (activeTabIndex == 0)
            {
                <MudText Typo="Typo.h6" Style="color: #212121; font-weight: 600; margin-bottom: 0.5rem;">No resources to learn</MudText>
                <MudText Typo="Typo.body2" Style="color: #757575; margin-bottom: 1.5rem;">Select a resource from All Resources to start learning</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AutoStories" OnClick="@(() => OnTabChangedAsync(3))"
                          Style="border-radius: 6px;">
                    Select a resource to Learn
                </MudButton>
            }
            else
            {
                <MudText Typo="Typo.h6" Style="color: #212121; font-weight: 600; margin-bottom: 0.5rem;">No resources found</MudText>
                <MudText Typo="Typo.body2" Style="color: #757575; margin-bottom: 1.5rem;">Start building your learning library</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog"
                          Style="border-radius: 6px;">
                    Add Your First Resource
                </MudButton>
            }
        </div>
    }
    else if (viewMode == ViewMode.List)
    {
        <MudDropContainer @key="@filterKey" T="LearningResource" Items="pagedResources" ItemsSelector="@((item, dropzone) => true)" 
                         ItemDropped="OnResourceDropped" Class="d-flex flex-column" Style="gap: 12px;">
            <ChildContent>
                <MudDropZone T="LearningResource" Identifier="main-zone" AllowReorder="true" Class="d-flex flex-column" Style="gap: 12px;" />
            </ChildContent>
            <ItemRenderer>
                <div class="resource-card draggable-item animate-fade-in-up" style="padding: 16px;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        @* Drag Handle *@
                        <div style="flex-shrink: 0;" class="drag-handle">
                            <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Style="cursor: grab; color: #9e9e9e;" />
                        </div>
                        
                        @* Thumbnail *@
                        <div style="flex-shrink: 0;">
                            <div class="thumbnail-container">
                                @if (context.ThumbnailImage != null && context.ThumbnailImage.Length > 0)
                                {
                                    <img src="@($"data:image/png;base64,{Convert.ToBase64String(context.ThumbnailImage)}")" 
                                         alt="@context.Title" />
                                }
                                else if (!string.IsNullOrEmpty(context.ThumbnailUrl))
                                {
                                    <img src="@context.ThumbnailUrl" 
                                         alt="@context.Title" />
                                }
                                else
                                {
                                    <div class="thumbnail-placeholder">
                                        <MudIcon Icon="@GetContentTypeIcon(context.ContentType)" Size="Size.Large" Style="color: #9e9e9e;" />
                                    </div>
                                }
                            </div>
                        </div>

                        @* Content *@
                        <div style="flex: 1; min-width: 0;">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #212121;">@context.Title</MudText>
                                <MudLink Href="@context.Url" Target="_blank" Typo="Typo.caption" Style="color: #5c6bc0; font-weight: 500;">
                                    @GetDomainFromUrl(context.Url) <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" />
                                </MudLink>
                                @if (!string.IsNullOrEmpty(context.Description))
                                {
                                    <MudText Typo="Typo.body2" Style="color: #757575; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        @context.Description
                                    </MudText>
                                }
                                <MudStack Row="true" Spacing="1" Class="mt-2" Style="flex-wrap: wrap;">
                                    <MudChip T="string" Size="Size.Small" Style="@GetContentTypeChipStyle(context.ContentType)">
                                        @context.ContentType
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@GetStatusChipStyle(context.Status)">
                                        @GetStatusText(context.Status)
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@GetPriorityChipStyle(context.Priority)">
                                        @context.Priority
                                    </MudChip>
                                </MudStack>
                                <MudText Typo="Typo.caption" Style="color: #9e9e9e; margin-top: 6px;">
                                    Added @GetRelativeDate(context.DateAdded)
                                </MudText>
                            </MudStack>
                        </div>

                        @* Actions *@
                        <div style="flex-shrink: 0;">
                            <MudStack Spacing="2">
                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Style="color: #5c6bc0;" OnClick="@(() => OpenEditDialog(context))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Style="color: #e53935;" OnClick="@(() => DeleteResource(context.Id))" />
                                </MudStack>
                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd">
                                    @if (context.Status != ContentStatus.InProgress)
                                    {
                                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => UpdateStatus(context, ContentStatus.InProgress))" 
                                                  Style="text-transform: none; font-size: 0.75rem; border-color: #fb8c00; color: #fb8c00; border-radius: 4px;">
                                            In Progress
                                        </MudButton>
                                    }
                                    @if (context.Status != ContentStatus.Completed)
                                    {
                                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => UpdateStatus(context, ContentStatus.Completed))" 
                                                  Style="text-transform: none; font-size: 0.7rem; border-color: #10b981; color: #10b981; border-radius: 8px;">
                                            Complete
                                        </MudButton>
                                    }
                                </MudStack>
                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd">
                                    <MudIconButton Icon="@(context.IsArchived ? Icons.Material.Filled.Unarchive : Icons.Material.Filled.Archive)" 
                                                  Size="Size.Small" 
                                                  Style="color: #94a3b8;" 
                                                  Title="@(context.IsArchived ? "Unarchive" : "Archive")" 
                                                  OnClick="@(() => ToggleArchive(context))" />
                                </MudStack>
                            </MudStack>
                        </div>
                    </div>
                </div>
            </ItemRenderer>
        </MudDropContainer>
        
        @* Pagination *@
        <div class="resource-card" style="padding: 16px; margin-top: 20px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Style="color: #64748b; font-weight: 500;">
                    Showing @((currentPage - 1) * pageSize + 1) - @(Math.Min(currentPage * pageSize, filteredResources.Count)) of @filteredResources.Count resources
                </MudText>
                <MudPagination Count="@totalPages" Selected="@currentPage" SelectedChanged="OnPageChanged" BoundaryCount="1" MiddleCount="3" 
                              Color="Color.Primary" Variant="Variant.Filled" />
            </MudStack>
        </div>
    }
    else if (viewMode == ViewMode.DataGrid)
    {
        <MudPaper Elevation="0" Style="border-radius: 16px; overflow: hidden; border: 1px solid rgba(102, 126, 234, 0.1);">
        <MudDataGrid T="LearningResource" Items="@pagedResources" Striped="true" Dense="false" Hover="true" ReadOnly="false"
                     Style="background: white;" HeaderClass="mud-theme-primary">
            <Columns>
                <PropertyColumn Property="x => x.Title" Title="Title">
                    <CellTemplate>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1e293b;">@context.Item.Title</MudText>
                            <MudLink Href="@context.Item.Url" Target="_blank" Typo="Typo.caption" Style="color: #667eea;">
                                @GetDomainFromUrl(context.Item.Url)
                            </MudLink>
                        </MudStack>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.ContentType" Title="Type">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Style="@GetContentTypeChipStyle(context.Item.ContentType)">
                            @context.Item.ContentType
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.Status" Title="Status">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Style="@GetStatusChipStyle(context.Item.Status)">
                            @GetStatusText(context.Item.Status)
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.Priority" Title="Priority">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Style="@GetPriorityChipStyle(context.Item.Priority)">
                            @context.Item.Priority
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.DateAdded" Title="Date Added">
                    <CellTemplate>
                        <MudText Typo="Typo.body2" Style="color: #64748b;">@GetRelativeDate(context.Item.DateAdded)</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Style="color: #667eea;" OnClick="@(() => OpenEditDialog(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Style="color: #ef4444;" OnClick="@(() => DeleteResource(context.Item.Id))" />
                            @if (context.Item.Status != ContentStatus.Completed)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="color: #10b981;" 
                                              OnClick="@(() => UpdateStatus(context.Item, ContentStatus.Completed))" 
                                              Title="Mark as Complete" />
                            }
                            <MudIconButton Icon="@(context.Item.IsArchived ? Icons.Material.Filled.Unarchive : Icons.Material.Filled.Archive)" 
                                          Size="Size.Small" Style="color: #94a3b8;" 
                                          Title="@(context.Item.IsArchived ? "Unarchive" : "Archive")" 
                                          OnClick="@(() => ToggleArchive(context.Item))" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
        </MudPaper>
        
        @* Pagination *@
        <div class="resource-card" style="padding: 16px; margin-top: 20px;">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Style="color: #64748b; font-weight: 500;">
                    Showing @((currentPage - 1) * pageSize + 1) - @(Math.Min(currentPage * pageSize, filteredResources.Count)) of @filteredResources.Count resources
                </MudText>
                <MudPagination Count="@totalPages" Selected="@currentPage" SelectedChanged="OnPageChanged" BoundaryCount="1" MiddleCount="3"
                              Color="Color.Primary" Variant="Variant.Filled" />
            </MudStack>
        </div>
    }
</MudContainer>

@code {
    private enum ViewMode
    {
        List,
        DataGrid
    }

    private List<LearningResource> resources = new();
    private List<LearningResource> filteredResources = new();
    private List<LearningResource> pagedResources = new();
    private string searchTerm = string.Empty;
    private ContentStatus? filterStatus;
    private ContentType? filterContentType;
    private Priority? filterPriority;
    private string sortOrder = "custom";
    private int filterKey = 0;
    private bool isLoading = true;
    private bool showFilters = false;
    private bool showArchived = false;
    private string userId = string.Empty;
    private int activeTabIndex = 0;
    private ViewMode viewMode = ViewMode.List;
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 50;
    private int totalPages = 1;

    // Statistics
    private int toLearnCount;
    private int inProgressCount;
    private int completedCount;
    private int contentIdeasCount;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;

        await ResourceService.ArchiveStaleResourcesAsync(userId);
        await LoadResources();
        await LoadStatistics();
    }

    private async Task LoadResources()
    {
        if (string.IsNullOrEmpty(userId)) return;

        isLoading = true;
        await LoadResourcesForCurrentTabAsync();
        ApplyFilters(true);
        isLoading = false;
    }

    private async Task LoadResourcesForCurrentTabAsync()
    {
        if (string.IsNullOrEmpty(userId)) return;

        resources = activeTabIndex switch
        {
            0 => await ResourceService.GetByStatusAsync(userId, ContentStatus.ToLearn),
            1 => await ResourceService.GetByStatusAsync(userId, ContentStatus.InProgress),
            2 => await ResourceService.GetByStatusAsync(userId, ContentStatus.Completed),
            _ => await ResourceService.GetAllAsync(userId)
        };
    }

    private async Task LoadStatistics()
    {
        if (string.IsNullOrEmpty(userId)) return;

        var allResources = await ResourceService.GetAllAsync(userId);
        toLearnCount = allResources.Count(r => r.Status == ContentStatus.ToLearn && !r.IsArchived);
        inProgressCount = allResources.Count(r => r.Status == ContentStatus.InProgress && !r.IsArchived);
        completedCount = allResources.Count(r => r.Status == ContentStatus.Completed && !r.IsArchived);

        var ideas = await ContentIdeaService.GetAllAsync(userId);
        contentIdeasCount = ideas.Count;
    }

    private void ApplyFilters(bool resetPage = false)
    {
        // Reset to page 1 if requested (typically when filters/sort changes)
        if (resetPage)
        {
            currentPage = 1;
        }

        filteredResources = resources;

        // Apply tab filter
        if (activeTabIndex == 0) // To Learn
        {
            filteredResources = filteredResources.Where(r => r.Status == ContentStatus.ToLearn && !r.IsArchived).ToList();
        }
        else if (activeTabIndex == 1) // Learning
        {
            filteredResources = filteredResources.Where(r => r.Status == ContentStatus.InProgress && !r.IsArchived).ToList();
        }
        else if (activeTabIndex == 2) // Completed
        {
            filteredResources = filteredResources.Where(r => r.Status == ContentStatus.Completed && !r.IsArchived).ToList();
        }
        // activeTabIndex == 3 is All Resources - filter by archived toggle
        else if (!showArchived)
        {
            filteredResources = filteredResources.Where(r => !r.IsArchived).ToList();
        }

        // Apply dropdown filters
        if (filterStatus.HasValue)
        {
            filteredResources = filteredResources.Where(r => r.Status == filterStatus.Value).ToList();
        }

        if (filterContentType.HasValue)
        {
            filteredResources = filteredResources.Where(r => r.ContentType == filterContentType.Value).ToList();
        }

        if (filterPriority.HasValue)
        {
            filteredResources = filteredResources.Where(r => r.Priority == filterPriority.Value).ToList();
        }

        // Apply search
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredResources = filteredResources.Where(r =>
                r.Title.ToLower().Contains(term) ||
                (r.Description?.ToLower().Contains(term) ?? false) ||
                (r.Notes?.ToLower().Contains(term) ?? false) ||
                (r.Tags?.ToLower().Contains(term) ?? false)
            ).ToList();
        }

        // Apply sorting
        filteredResources = sortOrder switch
        {
            "newest" => filteredResources.OrderByDescending(r => r.DateAdded).ToList(),
            "oldest" => filteredResources.OrderBy(r => r.DateAdded).ToList(),
            "priority" => filteredResources.OrderByDescending(r => r.Priority).ThenByDescending(r => r.DateAdded).ToList(),
            "title" => filteredResources.OrderBy(r => r.Title).ToList(),
            _ => filteredResources.OrderBy(r => r.CustomOrder).ThenByDescending(r => r.DateAdded).ToList()
        };

        // Calculate pagination
        totalPages = (int)Math.Ceiling(filteredResources.Count / (double)pageSize);
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }
        if (currentPage < 1)
        {
            currentPage = 1;
        }
        
        // Apply pagination
        pagedResources = filteredResources
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        filterKey++;
        StateHasChanged();
    }
    
    private void ApplyFiltersWithReset(string value)
    {
        ApplyFilters(true);
    }
    
    private void OnFilterChanged()
    {
        ApplyFilters(true);
    }

    private async Task OnTabChangedAsync(int tabIndex)
    {
        activeTabIndex = tabIndex;
        await LoadResources();
    }
    
    private void OnPageChanged(int page)
    {
        currentPage = page;
        pagedResources = filteredResources
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
        StateHasChanged();
    }

    private async Task OnResourceDropped(MudItemDropInfo<LearningResource> dropItem)
    {
        if (dropItem.Item == null) return;

        // Only allow reordering when sorting by custom order
        if (sortOrder != "custom")
        {
            return;
        }

        // Get the index in the paged list
        var oldIndex = pagedResources.IndexOf(dropItem.Item);
        if (oldIndex == -1) return;

        // Calculate the global index offset for the current page
        var pageOffset = (currentPage - 1) * pageSize;

        // Remove from old position
        pagedResources.RemoveAt(oldIndex);

        // Insert at new position (index in dropItem represents the new position)
        var newIndex = dropItem.IndexInZone;
        if (newIndex > pagedResources.Count)
            newIndex = pagedResources.Count;
            
        pagedResources.Insert(newIndex, dropItem.Item);

        // Update the order in the full filtered list
        var globalOldIndex = oldIndex + pageOffset;
        var globalNewIndex = newIndex + pageOffset;

        filteredResources.RemoveAt(globalOldIndex);
        filteredResources.Insert(globalNewIndex, dropItem.Item);

        // Update the order in database
        var orderedIds = filteredResources.Select(r => r.Id).ToList();
        await ResourceService.UpdateOrderAsync(userId, orderedIds);

        // Refresh the display
        StateHasChanged();
    }

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters
        {
            { nameof(ResourceForm.UserId), userId }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ResourceForm>("Add Learning Resource", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadResources();
            await LoadStatistics();
        }
    }

    private async Task OpenEditDialog(LearningResource resource)
    {
        var parameters = new DialogParameters
        {
            { nameof(ResourceForm.Resource), resource },
            { nameof(ResourceForm.UserId), userId }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ResourceForm>("Edit Learning Resource", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadResources();
            await LoadStatistics();
        }
    }

    private async Task DeleteResource(int id)
    {
        await ResourceService.DeleteAsync(id, userId);
        await LoadResources();
        await LoadStatistics();
    }

    private async Task UpdateStatus(LearningResource resource, ContentStatus newStatus)
    {
        resource.Status = newStatus;
        resource.DateCompleted = newStatus == ContentStatus.Completed ? DateTime.UtcNow : null;
        await ResourceService.UpdateAsync(resource, userId);
        await LoadStatistics();
        ApplyFilters();
    }

    private async Task ToggleArchive(LearningResource resource)
    {
        await ResourceService.ToggleArchiveAsync(resource.Id, userId);
        resource.IsArchived = !resource.IsArchived;
        await LoadStatistics();
        ApplyFilters();
    }

    private string GetDomainFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            return uri.Host.Replace("www.", "");
        }
        catch
        {
            return url;
        }
    }

    private string GetRelativeDate(DateTime date)
    {
        var diff = DateTime.UtcNow - date;
        if (diff.TotalDays < 1) return "Today";
        if (diff.TotalDays < 2) return "Yesterday";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30) return $"{(int)(diff.TotalDays / 7)} weeks ago";
        if (diff.TotalDays < 365) return $"{(int)(diff.TotalDays / 30)} months ago";
        return $"{(int)(diff.TotalDays / 365)} years ago";
    }

    private string GetContentTypeIcon(ContentType type) => type switch
    {
        ContentType.BlogPost => Icons.Material.Filled.Article,
        ContentType.Podcast => Icons.Material.Filled.Podcasts,
        ContentType.Video => Icons.Material.Filled.VideoLibrary,
        ContentType.Article => Icons.Material.Filled.Description,
        ContentType.Course => Icons.Material.Filled.School,
        ContentType.Documentation => Icons.Material.Filled.MenuBook,
        _ => Icons.Material.Filled.Link
    };

    private Color GetContentTypeColor(ContentType type) => type switch
    {
        ContentType.BlogPost => Color.Primary,
        ContentType.Podcast => Color.Secondary,
        ContentType.Video => Color.Error,
        ContentType.Article => Color.Info,
        ContentType.Course => Color.Warning,
        ContentType.Documentation => Color.Success,
        _ => Color.Default
    };

    private Color GetStatusColor(ContentStatus status) => status switch
    {
        ContentStatus.ToLearn => Color.Info,
        ContentStatus.InProgress => Color.Warning,
        ContentStatus.Completed => Color.Success,
        _ => Color.Default
    };

    private string GetStatusText(ContentStatus status) => status switch
    {
        ContentStatus.ToLearn => "To Learn",
        ContentStatus.InProgress => "In Progress",
        ContentStatus.Completed => "Completed",
        _ => "Unknown"
    };

    private Color GetPriorityColor(Priority priority) => priority switch
    {
        Priority.High => Color.Error,
        Priority.Medium => Color.Warning,
        Priority.Low => Color.Default,
        _ => Color.Default
    };

    private string GetPriorityStyle(Priority priority) => priority switch
    {
        Priority.High => "background-color: #ffebee; color: #c62828;",
        Priority.Medium => "background-color: #fff8e1; color: #f57f17;",
        Priority.Low => "background-color: #f5f5f5; color: #757575;",
        _ => ""
    };

    private string GetContentTypeChipStyle(ContentType contentType) => contentType switch
    {
        ContentType.Video => "background: #ffebee; color: #c62828; font-weight: 500;",
        ContentType.Article => "background: #e3f2fd; color: #1565c0; font-weight: 500;",
        ContentType.Course => "background: #fff3e0; color: #e65100; font-weight: 500;",
        ContentType.Podcast => "background: #f3e8ff; color: #7b1fa2; font-weight: 500;",
        ContentType.Documentation => "background: #e8f5e9; color: #2e7d32; font-weight: 500;",
        _ => "background: #f5f5f5; color: #616161; font-weight: 500;"
    };

    private string GetStatusChipStyle(ContentStatus status) => status switch
    {
        ContentStatus.ToLearn => "background: #e3f2fd; color: #1565c0; font-weight: 500;",
        ContentStatus.InProgress => "background: #fff3e0; color: #e65100; font-weight: 500;",
        ContentStatus.Completed => "background: #e8f5e9; color: #2e7d32; font-weight: 500;",
        _ => "background: #f5f5f5; color: #616161; font-weight: 500;"
    };

    private string GetPriorityChipStyle(Priority priority) => priority switch
    {
        Priority.High => "background: #ffebee; color: #c62828; font-weight: 500;",
        Priority.Medium => "background: #fff3e0; color: #e65100; font-weight: 500;",
        Priority.Low => "background: #f5f5f5; color: #616161; font-weight: 500;",
        _ => "background: #f5f5f5; color: #616161; font-weight: 500;"
    };

    private async Task ExportAsJson()
    {
        var exportData = filteredResources.Select(r => new
        {
            r.Title,
            r.Url,
            r.Description,
            ContentType = r.ContentType.ToString(),
            Status = r.Status.ToString(),
            Priority = r.Priority.ToString(),
            r.Tags,
            r.Notes,
            DateAdded = r.DateAdded.ToString("yyyy-MM-dd"),
            DateCompleted = r.DateCompleted?.ToString("yyyy-MM-dd")
        }).ToList();

        var json = JsonSerializer.Serialize(exportData, new JsonSerializerOptions 
        { 
            WriteIndented = true 
        });
        
        var fileName = $"learning-resources-{DateTime.Now:yyyyMMdd-HHmmss}.json";
        await DownloadFileAsync(fileName, json, "application/json");
    }

    private async Task ExportAsCsv()
    {
        var csv = new StringBuilder();
        csv.AppendLine("Title,URL,Description,Content Type,Status,Priority,Tags,Notes,Date Added,Date Completed");

        foreach (var resource in filteredResources)
        {
            csv.AppendLine($"\"{EscapeCsv(resource.Title)}\"," +
                          $"\"{EscapeCsv(resource.Url)}\"," +
                          $"\"{EscapeCsv(resource.Description)}\"," +
                          $"\"{resource.ContentType}\"," +
                          $"\"{resource.Status}\"," +
                          $"\"{resource.Priority}\"," +
                          $"\"{EscapeCsv(resource.Tags)}\"," +
                          $"\"{EscapeCsv(resource.Notes)}\"," +
                          $"\"{resource.DateAdded:yyyy-MM-dd}\"," +
                          $"\"{(resource.DateCompleted.HasValue ? resource.DateCompleted.Value.ToString("yyyy-MM-dd") : "")}\"");
        }

        var fileName = $"learning-resources-{DateTime.Now:yyyyMMdd-HHmmss}.csv";
        await DownloadFileAsync(fileName, csv.ToString(), "text/csv");
    }

    private string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
            return "";
        
        return value.Replace("\"", "\"\"");
    }

    private async Task DownloadFileAsync(string fileName, string content, string contentType)
    {
        var bytes = Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64, contentType);
    }
}
