@page "/shared/{ShareToken}"
@using LearnStack.Services
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject ISharedResourceGroupService SharedGroupService
@inject NavigationManager NavigationManager
@layout LearnStack.Components.Layout.MainLayout

<PageTitle>@(group != null ? $"{group.Name} - Shared Collection" : "Shared Collection") - LearnStack</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Class="py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Loading shared collection...</MudText>
        </MudStack>
    }
    else if (group == null)
    {
        <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 2px dashed #e0e0e0; border-radius: 12px;">
            <MudIcon Icon="@Icons.Material.Filled.LinkOff" Size="Size.Large" Style="font-size: 4rem; color: #bdbdbd;" />
            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #757575;">Collection Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #9e9e9e;">This shared collection doesn't exist or has been deactivated.</MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      Href="/"
                      Class="mt-4"
                      Style="border-radius: 6px;">
                Go Home
            </MudButton>
        </MudPaper>
    }
    else
    {
        @* Collection Header *@
        <MudPaper Elevation="2" Class="pa-6 mb-4" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                <div style="background: #26a69a; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center;">
                    <MudIcon Icon="@Icons.Material.Filled.Share" Style="color: white;" Size="Size.Medium" />
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5" Style="font-weight: 600;">@group.Name</MudText>
                    @if (group.User != null)
                    {
                        <MudText Typo="Typo.caption" Style="color: #9e9e9e;">Shared by @group.User.UserName?.Split('@')[0]</MudText>
                    }
                </MudStack>
            </MudStack>
            @if (!string.IsNullOrEmpty(group.Description))
            {
                <MudText Typo="Typo.body1" Style="color: #757575;" Class="mt-2">@group.Description</MudText>
            }
            <MudStack Row="true" Spacing="3" Class="mt-3">
                <MudChip T="string" Size="Size.Small" Style="background: #e0f2f1; color: #00695c;">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" Class="mr-1" />
                    @group.Items.Count resource(s)
                </MudChip>
                <MudChip T="string" Size="Size.Small" Style="background: #f5f5f5; color: #757575;">
                    @group.DateCreated.ToString("MMMM dd, yyyy")
                </MudChip>
            </MudStack>
        </MudPaper>

        @* Resources List *@
        @if (!group.Items.Any())
        {
            <MudPaper Elevation="0" Class="pa-6" Style="text-align: center; border: 1px solid #e0e0e0; border-radius: 12px;">
                <MudText Typo="Typo.body1" Style="color: #9e9e9e;">This collection has no resources yet.</MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid Spacing="3">
                @foreach (var item in group.Items)
                {
                    @if (item.LearningResource != null)
                    {
                        var resource = item.LearningResource;
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Elevation="2" Style="height: 100%; border-radius: 12px;">
                                @if (resource.ThumbnailImage != null)
                                {
                                    <MudCardMedia Image="@GetThumbnailDataUrl(resource)" Height="160" />
                                }
                                else
                                {
                                    <div style="height: 160px; background: linear-gradient(135deg, #e0f2f1, #b2dfdb); display: flex; align-items: center; justify-content: center; border-radius: 12px 12px 0 0;">
                                        <MudIcon Icon="@GetContentTypeIcon(resource.ContentType)" Size="Size.Large" Style="font-size: 3rem; color: #00695c; opacity: 0.5;" />
                                    </div>
                                }
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-2">
                                        <MudChip T="string" Size="Size.Small" Style="@GetContentTypeChipStyle(resource.ContentType)">
                                            @resource.ContentType
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" Style="@GetPriorityChipStyle(resource.Priority)">
                                            @resource.Priority
                                        </MudChip>
                                    </MudStack>
                                    <MudText Typo="Typo.h6" Style="font-weight: 600; font-size: 1rem;">@resource.Title</MudText>
                                    @if (!string.IsNullOrEmpty(resource.Description))
                                    {
                                        <MudText Typo="Typo.body2" Style="color: #757575;" Class="mt-1">
                                            @TruncateText(resource.Description, 120)
                                        </MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(resource.Tags))
                                    {
                                        <MudStack Row="true" Spacing="1" Class="mt-2" Style="flex-wrap: wrap;">
                                            @foreach (var tag in resource.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Take(3))
                                            {
                                                <MudChip T="string" Size="Size.Small" Style="background: #f5f5f5; color: #616161; font-size: 0.7rem;">@tag</MudChip>
                                            }
                                        </MudStack>
                                    }
                                </MudCardContent>
                                <MudCardActions Style="padding: 8px 16px;">
                                    <MudButton Variant="Variant.Text" 
                                              StartIcon="@Icons.Material.Filled.OpenInNew" 
                                              Href="@resource.Url"
                                              Target="_blank"
                                              Style="color: #26a69a;">
                                        Visit Resource
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                }
            </MudGrid>
        }

        @* Footer *@
        <MudStack AlignItems="AlignItems.Center" Class="mt-6">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.AutoStories" Size="Size.Small" Style="color: #5c6bc0;" />
                <MudText Typo="Typo.caption" Style="color: #9e9e9e;">Powered by LearnStack</MudText>
            </MudStack>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public string ShareToken { get; set; } = string.Empty;

    private SharedResourceGroup? group;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(ShareToken))
        {
            group = await SharedGroupService.GetByShareTokenAsync(ShareToken);
        }
        isLoading = false;
    }

    private string GetThumbnailDataUrl(LearningResource resource)
    {
        if (resource.ThumbnailImage == null) return string.Empty;
        return $"data:image/png;base64,{Convert.ToBase64String(resource.ThumbnailImage)}";
    }

    private string TruncateText(string text, int maxLength)
    {
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    private string GetContentTypeIcon(ContentType type) => type switch
    {
        ContentType.BlogPost => Icons.Material.Filled.Article,
        ContentType.Podcast => Icons.Material.Filled.Podcasts,
        ContentType.Video => Icons.Material.Filled.OndemandVideo,
        ContentType.Article => Icons.Material.Filled.Description,
        ContentType.Course => Icons.Material.Filled.School,
        ContentType.Documentation => Icons.Material.Filled.MenuBook,
        _ => Icons.Material.Filled.Link
    };

    private string GetContentTypeChipStyle(ContentType type) => type switch
    {
        ContentType.BlogPost => "background: #e3f2fd; color: #1565c0;",
        ContentType.Podcast => "background: #f3e5f5; color: #7b1fa2;",
        ContentType.Video => "background: #fce4ec; color: #c62828;",
        ContentType.Article => "background: #e8eaf6; color: #283593;",
        ContentType.Course => "background: #fff3e0; color: #e65100;",
        ContentType.Documentation => "background: #e0f2f1; color: #00695c;",
        _ => "background: #f5f5f5; color: #616161;"
    };

    private string GetPriorityChipStyle(Priority priority) => priority switch
    {
        Priority.High => "background: #fce4ec; color: #c62828;",
        Priority.Medium => "background: #fff3e0; color: #e65100;",
        Priority.Low => "background: #f5f5f5; color: #757575;",
        _ => "background: #f5f5f5; color: #757575;"
    };
}
