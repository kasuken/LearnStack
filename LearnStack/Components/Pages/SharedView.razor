@page "/shared/{ShareToken}"
@using LearnStack.Services
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inject ISharedResourceGroupService SharedGroupService
@inject NavigationManager NavigationManager
@layout LearnStack.Components.Layout.MainLayout

<PageTitle>@(group != null ? $"{group.Name} - Shared Collection" : "Shared Collection") - LearnStack</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Class="py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Loading shared collection...</MudText>
        </MudStack>
    }
    else if (group == null)
    {
        <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 2px dashed #e2e8f0; border-radius: 16px; background: #f8fafc;">
            <MudIcon Icon="@Icons.Material.Filled.LinkOff" Size="Size.Large" Style="font-size: 4rem; color: #cbd5e1;" />
            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #475569; font-weight: 600;">Collection Not Found</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #64748b;">This shared collection doesn't exist or has been deactivated.</MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      Href="/"
                      Class="mt-4"
                      Style="border-radius: 10px; font-weight: 600;">
                Go Home
            </MudButton>
        </MudPaper>
    }
    else
    {
        @* Collection Header *@
        <MudPaper Elevation="0" Class="pa-6 mb-4" Style="border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.05);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                <div style="background: linear-gradient(135deg, #10b981, #34d399); border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);">
                    <MudIcon Icon="@Icons.Material.Filled.Share" Style="color: white;" Size="Size.Medium" />
                </div>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #0f172a; letter-spacing: -0.5px;">@group.Name</MudText>
                    @if (group.User != null)
                    {
                        <MudText Typo="Typo.caption" Style="color: #64748b; font-weight: 500;">Shared by @group.User.UserName?.Split('@')[0]</MudText>
                    }
                </MudStack>
            </MudStack>
            @if (!string.IsNullOrEmpty(group.Description))
            {
                <MudText Typo="Typo.body1" Style="color: #475569; line-height: 1.6;" Class="mt-3">@group.Description</MudText>
            }
            <MudStack Row="true" Spacing="3" Class="mt-4">
                <MudChip T="string" Size="Size.Small" Style="background: #dcfce7; color: #059669; font-weight: 600; border-radius: 6px;">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" Class="mr-1" />
                    @group.Items.Count resource(s)
                </MudChip>
                <MudChip T="string" Size="Size.Small" Style="background: #f1f5f9; color: #475569; font-weight: 600; border-radius: 6px;">
                    @group.DateCreated.ToString("MMMM dd, yyyy")
                </MudChip>
            </MudStack>
        </MudPaper>

        @* Resources List *@
        @if (!group.Items.Any())
        {
            <MudPaper Elevation="0" Class="pa-6" Style="text-align: center; border: 1px solid #e2e8f0; border-radius: 16px; background: #f8fafc;">
                <MudText Typo="Typo.body1" Style="color: #64748b;">This collection has no resources yet.</MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid Spacing="3">
                @foreach (var item in group.Items)
                {
                    @if (item.LearningResource != null)
                    {
                        var resource = item.LearningResource;
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Elevation="0" Style="height: 100%; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.05); overflow: hidden;">
                                @if (resource.ThumbnailImage != null)
                                {
                                    <MudCardMedia Image="@GetThumbnailDataUrl(resource)" Height="160" Style="border-bottom: 1px solid #e2e8f0;" />
                                }
                                else
                                {
                                    <div style="height: 160px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #e2e8f0;">
                                        <MudIcon Icon="@GetContentTypeIcon(resource.ContentType)" Size="Size.Large" Style="font-size: 3rem; color: #cbd5e1;" />
                                    </div>
                                }
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                        <MudChip T="string" Size="Size.Small" Style="@(GetContentTypeChipStyle(resource.ContentType) + "; font-weight: 600; border-radius: 6px;")">
                                            @resource.ContentType
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" Style="@(GetPriorityChipStyle(resource.Priority) + "; font-weight: 600; border-radius: 6px;")">
                                            @resource.Priority
                                        </MudChip>
                                    </MudStack>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700; font-size: 1.1rem; color: #0f172a; line-height: 1.4;" Class="mb-2">@resource.Title</MudText>
                                    @if (!string.IsNullOrEmpty(resource.Description))
                                    {
                                        <MudText Typo="Typo.body2" Style="color: #475569; line-height: 1.6;" Class="mb-3">
                                            @TruncateText(resource.Description, 120)
                                        </MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(resource.Tags))
                                    {
                                        <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                                            @foreach (var tag in resource.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Take(3))
                                            {
                                                <MudChip T="string" Size="Size.Small" Style="background: #f1f5f9; color: #475569; font-size: 0.75rem; font-weight: 500; border-radius: 6px;">@tag</MudChip>
                                            }
                                        </MudStack>
                                    }
                                </MudCardContent>
                                <MudCardActions Style="padding: 12px 16px; border-top: 1px solid #f1f5f9; background: #f8fafc;">
                                    <MudButton Variant="Variant.Text" 
                                              StartIcon="@Icons.Material.Filled.OpenInNew" 
                                              Href="@resource.Url"
                                              Target="_blank"
                                              Style="color: #4f46e5; font-weight: 600; border-radius: 8px;">
                                        Visit Resource
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                }
            </MudGrid>
        }

        @* Footer *@
        <MudStack AlignItems="AlignItems.Center" Class="mt-8 mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <div style="background: linear-gradient(135deg, #4f46e5, #818cf8); border-radius: 8px; padding: 6px; display: flex; align-items: center; justify-content: center;">
                    <MudIcon Icon="@Icons.Material.Filled.AutoStories" Size="Size.Small" Style="color: white;" />
                </div>
                <MudText Typo="Typo.caption" Style="color: #64748b; font-weight: 600; letter-spacing: 0.5px;">POWERED BY LEARNSTACK</MudText>
            </MudStack>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public string ShareToken { get; set; } = string.Empty;

    private SharedResourceGroup? group;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(ShareToken))
        {
            group = await SharedGroupService.GetByShareTokenAsync(ShareToken);
        }
        isLoading = false;
    }

    private string GetThumbnailDataUrl(LearningResource resource)
    {
        if (resource.ThumbnailImage == null) return string.Empty;
        return $"data:image/png;base64,{Convert.ToBase64String(resource.ThumbnailImage)}";
    }

    private string TruncateText(string text, int maxLength)
    {
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    private string GetContentTypeIcon(ContentType type) => type switch
    {
        ContentType.BlogPost => Icons.Material.Filled.Article,
        ContentType.Podcast => Icons.Material.Filled.Podcasts,
        ContentType.Video => Icons.Material.Filled.OndemandVideo,
        ContentType.Article => Icons.Material.Filled.Description,
        ContentType.Course => Icons.Material.Filled.School,
        ContentType.Documentation => Icons.Material.Filled.MenuBook,
        _ => Icons.Material.Filled.Link
    };

    private string GetContentTypeChipStyle(ContentType type) => type switch
    {
        ContentType.BlogPost => "background: #eff6ff; color: #2563eb;",
        ContentType.Podcast => "background: #faf5ff; color: #9333ea;",
        ContentType.Video => "background: #fef2f2; color: #dc2626;",
        ContentType.Article => "background: #eef2ff; color: #4f46e5;",
        ContentType.Course => "background: #fff7ed; color: #ea580c;",
        ContentType.Documentation => "background: #ecfdf5; color: #059669;",
        _ => "background: #f1f5f9; color: #475569;"
    };

    private string GetPriorityChipStyle(Priority priority) => priority switch
    {
        Priority.High => "background: #fef2f2; color: #dc2626;",
        Priority.Medium => "background: #fffbeb; color: #d97706;",
        Priority.Low => "background: #f1f5f9; color: #64748b;",
        _ => "background: #f1f5f9; color: #64748b;"
    };
}
