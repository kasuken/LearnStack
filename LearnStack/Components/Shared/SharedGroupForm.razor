@using LearnStack.Services
@using LearnStack.Data.Models
@inject ISharedResourceGroupService SharedGroupService
@inject ILearningResourceService ResourceService

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@isValid">
            <MudTextField @bind-Value="model.Name"
                         Label="Group Name"
                         Required="true"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Counter="500"
                         MaxLength="500"
                         HelperText="Give your shared collection a name" />

            <MudTextField @bind-Value="model.Description"
                         Label="Description"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Lines="3"
                         Counter="2000"
                         MaxLength="2000"
                         HelperText="Describe what this collection is about" />

            <MudSwitch @bind-Value="model.IsActive" 
                      Color="Color.Primary"
                      Label="@(model.IsActive ? "Active (link is accessible)" : "Inactive (link is disabled)")" />

            @if (availableResources.Any())
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2" Style="font-weight: 600; color: #0f172a;">Select Resources</MudText>
                
                @* Filters Section *@
                <MudPaper Elevation="0" Class="pa-3 mb-2" Style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                    <MudGrid Spacing="2">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="searchText"
                                        Label="Search"
                                        Variant="Variant.Outlined"
                                        Margin="Margin.Dense"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Search"
                                        Immediate="true"
                                        DebounceInterval="300"
                                        Placeholder="Search by title or tags..." />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudSelect @bind-Value="filterContentType"
                                     Label="Content Type"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     AdornmentIcon="@Icons.Material.Filled.Category">
                                <MudSelectItem T="ContentType?" Value="@((ContentType?)null)">All Types</MudSelectItem>
                                @foreach (ContentType type in Enum.GetValues(typeof(ContentType)))
                                {
                                    <MudSelectItem T="ContentType?" Value="@type">@type.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudSelect @bind-Value="filterStatus"
                                     Label="Status"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     AdornmentIcon="@Icons.Material.Filled.Flag">
                                <MudSelectItem T="ContentStatus?" Value="@((ContentStatus?)null)">All Statuses</MudSelectItem>
                                @foreach (ContentStatus status in Enum.GetValues(typeof(ContentStatus)))
                                {
                                    <MudSelectItem T="ContentStatus?" Value="@status">@status.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudSelect @bind-Value="filterPriority"
                                     Label="Priority"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Clearable="true"
                                     AdornmentIcon="@Icons.Material.Filled.PriorityHigh">
                                <MudSelectItem T="Priority?" Value="@((Priority?)null)">All Priorities</MudSelectItem>
                                @foreach (Priority priority in Enum.GetValues(typeof(Priority)))
                                {
                                    <MudSelectItem T="Priority?" Value="@priority">@priority.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                    @if (HasActiveFilters())
                    {
                        <MudButton OnClick="ClearFilters" 
                                  Size="Size.Small" 
                                  StartIcon="@Icons.Material.Filled.Clear" 
                                  Class="mt-2"
                                  Style="text-transform: none; color: #64748b; font-weight: 500;">
                            Clear Filters
                        </MudButton>
                    }
                </MudPaper>

                @* Resources List *@
                <MudPaper Elevation="0" Style="border: 1px solid #e2e8f0; border-radius: 12px; max-height: 300px; overflow-y: auto; background: #f8fafc;">
                    @{
                        var filteredResources = GetFilteredResources();
                    }
                    @if (filteredResources.Any())
                    {
                        @foreach (var resource in filteredResources)
                        {
                            <MudCheckBox T="bool" 
                                        Value="@selectedResourceIds.Contains(resource.Id)"
                                        ValueChanged="@((bool val) => ToggleResource(resource.Id, val))"
                                        Dense="true"
                                        Class="px-3 py-1"
                                        Color="Color.Primary">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Style="color: #0f172a; font-weight: 500;">@resource.Title</MudText>
                                    <MudChip T="string" Size="Size.Small" Style="height: 20px; background: #f1f5f9; color: #475569; font-size: 0.7rem; font-weight: 600; border-radius: 4px;">@resource.ContentType</MudChip>
                                </MudStack>
                            </MudCheckBox>
                        }
                    }
                    else
                    {
                        <div class="pa-4" style="text-align: center; color: #64748b;">
                            <MudText Typo="Typo.body2">No resources match the selected filters</MudText>
                        </div>
                    }
                </MudPaper>
                <MudText Typo="Typo.caption" Style="color: #64748b; font-weight: 500;" Class="mt-2 d-block">
                    @selectedResourceIds.Count of @GetFilteredResources().Count() resource(s) selected
                </MudText>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4" Style="border-radius: 12px;">No learning resources available. Add some resources first.</MudAlert>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Style="color: #64748b; font-weight: 600; border-radius: 8px;">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                  Variant="Variant.Filled" 
                  OnClick="Submit"
                  Disabled="@(!isValid)"
                  Style="font-weight: 600; border-radius: 8px; padding: 8px 24px;">
            @(IsEditMode ? "Update" : "Create")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public SharedResourceGroup? Group { get; set; }

    [Parameter]
    public string UserId { get; set; } = string.Empty;

    private MudForm form = null!;
    private bool isValid;
    private SharedGroupFormModel model = new();
    private bool IsEditMode => Group != null;
    private List<LearningResource> availableResources = new();
    private HashSet<int> selectedResourceIds = new();

    // Filter state
    private string searchText = string.Empty;
    private ContentType? filterContentType = null;
    private ContentStatus? filterStatus = null;
    private Priority? filterPriority = null;

    protected override async Task OnInitializedAsync()
    {
        availableResources = await ResourceService.GetAllAsync(UserId);

        if (Group != null)
        {
            model = new SharedGroupFormModel
            {
                Name = Group.Name,
                Description = Group.Description,
                IsActive = Group.IsActive
            };
            selectedResourceIds = Group.Items.Select(i => i.LearningResourceId).ToHashSet();
        }
        else
        {
            model = new SharedGroupFormModel
            {
                IsActive = true
            };
        }
    }

    private void ToggleResource(int resourceId, bool selected)
    {
        if (selected)
            selectedResourceIds.Add(resourceId);
        else
            selectedResourceIds.Remove(resourceId);
    }

    private IEnumerable<LearningResource> GetFilteredResources()
    {
        var filtered = availableResources.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.ToLower();
            filtered = filtered.Where(r => 
                r.Title.ToLower().Contains(search) || 
                (r.Tags != null && r.Tags.ToLower().Contains(search)));
        }

        // Content type filter
        if (filterContentType.HasValue)
        {
            filtered = filtered.Where(r => r.ContentType == filterContentType.Value);
        }

        // Status filter
        if (filterStatus.HasValue)
        {
            filtered = filtered.Where(r => r.Status == filterStatus.Value);
        }

        // Priority filter
        if (filterPriority.HasValue)
        {
            filtered = filtered.Where(r => r.Priority == filterPriority.Value);
        }

        return filtered.OrderBy(r => r.Title);
    }

    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(searchText) || 
               filterContentType.HasValue || 
               filterStatus.HasValue || 
               filterPriority.HasValue;
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        filterContentType = null;
        filterStatus = null;
        filterPriority = null;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Submit()
    {
        await form.Validate();

        if (!isValid)
            return;

        if (IsEditMode && Group != null)
        {
            Group.Name = model.Name;
            Group.Description = model.Description;
            Group.IsActive = model.IsActive;

            await SharedGroupService.UpdateAsync(Group, UserId);

            // Sync resources: remove unselected, add newly selected
            var currentIds = Group.Items.Select(i => i.LearningResourceId).ToHashSet();
            foreach (var id in currentIds.Except(selectedResourceIds))
            {
                await SharedGroupService.RemoveResourceAsync(Group.Id, id, UserId);
            }
            foreach (var id in selectedResourceIds.Except(currentIds))
            {
                await SharedGroupService.AddResourceAsync(Group.Id, id, UserId);
            }
        }
        else
        {
            var newGroup = new SharedResourceGroup
            {
                Name = model.Name,
                Description = model.Description,
                IsActive = model.IsActive,
                UserId = UserId,
                DateCreated = DateTime.UtcNow
            };

            var created = await SharedGroupService.CreateAsync(newGroup);

            foreach (var resourceId in selectedResourceIds)
            {
                await SharedGroupService.AddResourceAsync(created.Id, resourceId, UserId);
            }
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    private class SharedGroupFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
