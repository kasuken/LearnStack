@using LearnStack.Services
@inject ILearningResourceService ResourceService

<MudCard Elevation="0" Class="resource-card d-flex flex-column" Style="height: 100%; border-radius: 16px; overflow: hidden;">
    @if (Resource.ThumbnailImage != null)
    {
        <MudCardMedia Image="@GetThumbnailDataUrl()" Height="180" Style="border-bottom: 1px solid #e2e8f0;" />
    }
    else
    {
        <MudCardMedia Height="180" Style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #e2e8f0;">
            <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Style="font-size: 4rem; color: #cbd5e1;" />
        </MudCardMedia>
    }
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6" Style="font-weight: 700; line-height: 1.3; margin-bottom: 4px; color: #0f172a;">@Resource.Title</MudText>
            <MudChip T="string" Size="Size.Small" Color="GetContentTypeColor()" Class="mt-1" Style="font-weight: 600; border-radius: 6px;">
                @Resource.ContentType.ToString()
            </MudChip>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                          Size="Size.Small" 
                          OnClick="OnEdit" 
                          Style="color: #64748b;" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                          Size="Size.Small" 
                          Color="Color.Error"
                          OnClick="OnDelete" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent Class="flex-grow-1" Style="padding-top: 0;">
        @if (!string.IsNullOrEmpty(Resource.Description))
        {
            <MudText Typo="Typo.body2" Style="color: #475569; line-height: 1.6;" Class="mb-3">
                @(Resource.Description.Length > 120 ? Resource.Description.Substring(0, 120) + "..." : Resource.Description)
            </MudText>
        }
        
        <MudDivider Class="my-3" Style="border-color: #f1f5f9;" />
        
        <MudStack Row="true" Spacing="2" Class="mb-3">
            <MudChip T="string" Size="Size.Small" Color="GetStatusColor()" Style="font-weight: 600; border-radius: 6px;">
                @GetStatusText()
            </MudChip>
            <MudChip T="string" Size="Size.Small" Color="GetPriorityColor()" Style="font-weight: 600; border-radius: 6px;">
                @Resource.Priority.ToString()
            </MudChip>
        </MudStack>

        @if (!string.IsNullOrEmpty(Resource.Tags))
        {
            <MudStack Row="true" Spacing="1" Class="flex-wrap mb-2">
                @foreach (var tag in Resource.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                {
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Style="border-radius: 6px; color: #64748b; border-color: #cbd5e1;">@tag.Trim()</MudChip>
                }
            </MudStack>
        }

        @if (!string.IsNullOrEmpty(Resource.Notes))
        {
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #f1f5f9;">
                <MudText Typo="Typo.caption" Style="color: #64748b; font-weight: 600; display: block; margin-bottom: 4px;">NOTES</MudText>
                <MudText Typo="Typo.body2" Style="color: #334155; font-style: italic;">
                    @(Resource.Notes.Length > 80 ? Resource.Notes.Substring(0, 80) + "..." : Resource.Notes)
                </MudText>
            </div>
        }
    </MudCardContent>
    <MudCardActions Style="padding: 8px 16px 16px; border-top: 1px solid #f8fafc;">
        <MudButton Href="@Resource.Url" 
                  Target="_blank" 
                  StartIcon="@Icons.Material.Filled.OpenInNew"
                  Size="Size.Small"
                  Variant="Variant.Text"
                  Color="Color.Primary"
                  Style="font-weight: 600; border-radius: 8px;">
            Open Link
        </MudButton>
        <MudSpacer />
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Style="color: #64748b;" PopoverClass="rounded-xl shadow-lg border border-slate-100">
            <MudMenuItem OnClick="@(() => UpdateStatus(ContentStatus.ToLearn))" Style="border-radius: 8px; margin: 4px;">Mark as To Learn</MudMenuItem>
            <MudMenuItem OnClick="@(() => UpdateStatus(ContentStatus.InProgress))" Style="border-radius: 8px; margin: 4px;">Mark as In Progress</MudMenuItem>
            <MudMenuItem OnClick="@(() => UpdateStatus(ContentStatus.Completed))" Style="border-radius: 8px; margin: 4px;">Mark as Completed</MudMenuItem>
        </MudMenu>
    </MudCardActions>
</MudCard>

@code {
    [Parameter]
    public LearningResource Resource { get; set; } = null!;

    [Parameter]
    public string UserId { get; set; } = string.Empty;

    [Parameter]
    public EventCallback OnEdit { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    [Parameter]
    public EventCallback OnStatusChange { get; set; }

    private Color GetContentTypeColor()
    {
        return Resource.ContentType switch
        {
            ContentType.BlogPost => Color.Primary,
            ContentType.Podcast => Color.Secondary,
            ContentType.Video => Color.Error,
            ContentType.Article => Color.Info,
            ContentType.Course => Color.Warning,
            ContentType.Documentation => Color.Success,
            _ => Color.Default
        };
    }

    private Color GetStatusColor()
    {
        return Resource.Status switch
        {
            ContentStatus.ToLearn => Color.Info,
            ContentStatus.InProgress => Color.Warning,
            ContentStatus.Completed => Color.Success,
            _ => Color.Default
        };
    }

    private Color GetPriorityColor()
    {
        return Resource.Priority switch
        {
            Priority.High => Color.Error,
            Priority.Medium => Color.Warning,
            Priority.Low => Color.Default,
            _ => Color.Default
        };
    }

    private string GetStatusText()
    {
        return Resource.Status switch
        {
            ContentStatus.ToLearn => "To Learn",
            ContentStatus.InProgress => "In Progress",
            ContentStatus.Completed => "Completed",
            _ => "Unknown"
        };
    }

    private string GetThumbnailDataUrl()
    {
        if (Resource.ThumbnailImage == null || Resource.ThumbnailImage.Length == 0)
            return string.Empty;
        
        return $"data:image/png;base64,{Convert.ToBase64String(Resource.ThumbnailImage)}";
    }

    private async Task UpdateStatus(ContentStatus newStatus)
    {
        Resource.Status = newStatus;
        if (newStatus == ContentStatus.Completed)
        {
            Resource.DateCompleted = DateTime.UtcNow;
        }
        else
        {
            Resource.DateCompleted = null;
        }
        
        await ResourceService.UpdateAsync(Resource, UserId);
        await OnStatusChange.InvokeAsync();
    }
}




